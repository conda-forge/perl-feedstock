{% set unix_version = "5.38.2" %}
{% set win_version = unix_version + ".2" %}
{% set major_minor_version = unix_version.split(".")[:2] | join(".") %}

package:
  name: perl
  version: {{ unix_version }}  # [not win]
  version: {{ win_version }}   # [win]

source:
  - url: http://www.cpan.org/src/5.0/perl-{{ unix_version }}.tar.xz           # [unix]
    sha256: d91115e90b896520e83d4de6b52f8254ef2b70a8d545ffab33200ea9f1cf29e8  # [unix]
    patches:                                                                  # [unix]
      - 0001-Use-userelocatableinc-together-with-useshrplib.patch             # [unix]
      - 0002-Disable-direct-invocation-of-linker-if-LD-is-set.patch           # [unix]
  - url: https://github.com/StrawberryPerl/Perl-Dist-Strawberry/releases/download/SP_{{ win_version | replace(".", "") }}_64bit/strawberry-perl-{{ win_version }}-64bit-portable.zip  # [win]
    sha256: ea451686065d6338d7e4d4a04c9af49f17951d15aa4c2e19ab8cb56fa2373440  # [win]
    # sha1 hashes published at: http://strawberryperl.com/releases.html

build:
  number: 0
  string: {{ PKG_BUILDNUM }}_h{{ PKG_HASH }}_strawberry  # [win]
  string: {{ PKG_BUILDNUM }}_h{{ PKG_HASH }}_perl5       # [not win]
  run_exports:
    weak:
      - >-
        {{ pin_subpackage("perl", max_pin="x.x") }}
        *_strawberry  # [win]
        *_perl5       # [not win]
    noarch:
      - >-
        {{ pin_subpackage("perl", max_pin="x") }}
        *_strawberry  # [win]
        *_perl5       # [not win]

requirements:
  build:
    - {{ compiler('c') }}  # [unix]
    - make                 # [unix]
    - posix                # [win]
  host:
    - libxcrypt  # [linux]

test:
  # downstreams:
  #   - git
  #   - automake
  commands:
    - perl --help
    - |  # [unix]
      perl -V:cf_by | grep -qF "'conda'"  # [unix]
      perl -V:cf_email | grep -qF "'conda'"  # [unix]
      perl -V:perladmin | grep -qF "'conda'"  # [unix]
      perl -e 'print "$_\n" for @INC' | grep -qxF "${PREFIX}/lib/perl5/site_perl"  # [unix]
      perl -e 'print "$_\n" for @INC' | grep -qxF "${PREFIX}/lib/perl5/vendor_perl"  # [unix]
      perl -e 'print "$_\n" for @INC' | grep -qxF "${PREFIX}/lib/perl5/core_perl"  # [unix]
      perl -e 'print "$_\n" for @INC' | grep -qxF "${PREFIX}/lib/perl5/{{ major_minor_version }}/site_perl"  # [unix]
      perl -e 'print "$_\n" for @INC' | grep -qxF "${PREFIX}/lib/perl5/{{ major_minor_version }}/vendor_perl"  # [unix]
      perl -e 'print "$_\n" for @INC' | grep -qxF "${PREFIX}/lib/perl5/{{ major_minor_version }}/core_perl"  # [unix]
    # conda replaces back- by forward slashes during prefix placeholder replacement on installs:
    #   This means our Config.pm and Config_heavy.pl etc. carry mixed back-/forward slashes
    #   which Perl seems to handle well, though.
    #   refs:
    #     - https://github.com/conda/conda/blob/4.10.3/conda/core/portability.py#L37-L40
    #     - https://github.com/conda/conda/pull/2630#discussion_r66468372
    - perl -V:privlib | findstr "/C:%PREFIX:\=/%\Library\lib"  # [win]
    - perl -V:archlib | findstr "/C:%PREFIX:\=/%\Library\lib"  # [win]
    - perl -V:sitelib | findstr "/C:%PREFIX:\=/%\Library\site\lib"  # [win]
    - perl -V:sitearch | findstr "/C:%PREFIX:\=/%\Library\site\lib"  # [win]
    - perl -V:vendorlib | findstr "/C:%PREFIX:\=/%\Library\vendor\lib"  # [win]
    - perl -V:vendorarch | findstr "/C:%PREFIX:\=/%\Library\vendor\lib"  # [win]

about:
  home: http://www.perl.org/
  license: GPL-1.0-or-later OR Artistic-1.0-Perl
  license_file:
    - Artistic  # [unix]
    - Copying   # [unix]
    - licenses/perl/Artistic  # [win]
    - licenses/perl/Copying  # [win]
  summary: "The Perl programming language interpreter."
  description: |
    Perl 5 is a highly capable, feature-rich programming language with over 29
    years of development. Perl 5 runs on over 100 platforms from portables to
    mainframes and is suitable for both rapid prototyping and large scale
    development projects.
  doc_url: https://www.perl.org/docs.html
  dev_url: https://perl5.git.perl.org/perl.git

extra:
  recipe-maintainers:
    - jakirkham
    - msarahan
    - mingwandroid
    - isuruf
    - mbargull
